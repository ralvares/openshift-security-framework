= Lab: Who Am I on the Outside? – Controlling Outbound Identity with EgressIP
:role: Intermediate Network Governance
:skills: Egress Attribution, Namespace Identity, External Firewall Alignment
:mitre: T1041 (Exfiltration Over C2 Channel), T1071 (Application Layer Protocol), TA0010 (Exfiltration)
:compliance: NIST 800-53 SC-7, ISO 27001 A.13, PCI DSS 1.3
:labid: LAB-I4A

== Skill
Assign a deterministic outbound IP to a namespace to make external traffic traceable, enforce precise firewall rules, and accelerate incident scoping.

== Objective
* Label a namespace for egress control
* Create an EgressIP resource mapping to a reserved external IP
* Validate pod egress reflects the assigned IP
* Compare behavior vs a control namespace without EgressIP

== Why it Matters
Picture a large office tower with one anonymous exit; a suspicious package appears outside and you have no idea which floor’s team walked out with it. Deterministic egress identity (EgressIP) is like assigning each critical department its own marked exit door. When something odd hits the external firewall logs, you immediately know which namespace sourced it. Business value: faster investigations, tighter firewall scoping, cleaner compliance evidence about data exfiltration controls.

== What it Solves
Unlabeled outbound traffic encourages over‑broad firewalls (“just allow the whole node CIDR”) and slows incident response (“Which team triggered that outbound DNS burst?”). EgressIP restores accountability by stamping a namespace’s traffic with a stable, pre‑approved IP—tightening external ACLs while remaining transparent to application code.

== Understanding the Attack Surface
| Vector | Without Attribution | With EgressIP |
|--------|---------------------|--------------|
| Data Exfiltration | Slow source identification | Rapid namespace pinpoint |
| Shadow Services | Hard to notice rogue calls | Per‑namespace allowlists |
| Firewall Scope | Wide CIDR allowances | Narrow explicit IP rules |
| Incident Containment | Broad quarantine needed | Surgical namespace isolation |

== How to Secure (Lifecycle View)
* Build: Remove gratuitous external calls (telemetry, update checks) unless justified.
* Registry: Restrict image pulls to approved registries; pair with egress identity.
* Deploy: Label sensitive namespaces early; assign EgressIP before go‑live.
* Runtime: Monitor per‑EgressIP traffic baselines; alert on volume or geo anomalies.

== How to Try It
Prereqs: OVN-Kubernetes, a spare IP on the same L2 segment as worker nodes.

1. Namespace & label:
[source,sh]
----
oc new-project i4-egress-demo
oc label namespace i4-egress-demo egress=tracked
----
2. Create EgressIP (replace placeholder IP):
[source,sh]
----
cat <<'EOF' | oc apply -f -
apiVersion: k8s.ovn.org/v1
kind: EgressIP
metadata:
  name: i4-egressip
spec:
  egressIPs:
  - 10.10.10.200  # CHANGE ME to reserved IP
  namespaceSelector:
    matchLabels:
      egress: tracked
EOF
oc get egressip i4-egressip -o yaml | egrep 'egressIPs|node'
----
3. Test pod from tracked namespace:
[source,sh]
----
oc run tester --image=registry.access.redhat.com/ubi9/ubi -- sleep 3600
oc exec tester -- curl -s ifconfig.me || oc exec tester -- curl -s https://ifconfig.me
----
Confirm returned IP = reserved EgressIP after propagation.
4. Control namespace (no EgressIP):
[source,sh]
----
oc new-project i4-egress-control
oc run plain --image=registry.access.redhat.com/ubi9/ubi -- sleep 3600
oc exec plain -- curl -s ifconfig.me
----
Observe: shows node IP (or shared outbound IP), not the dedicated one.
5. (Optional) External log correlation: Inspect external HTTP server / proxy logs for the EgressIP as source.

== Troubleshooting
| Symptom | Likely Cause | Resolution |
|---------|--------------|-----------|
| EgressIP pending | IP not in correct L2 | Allocate proper subnet IP |
| Still node IP | ARP / routing not converged | Retry after short delay |
| Shared IP between namespaces | Misconfiguration | Assign unique IPs |

== Solutions/Controls
* EgressIP: Deterministic outbound identity per namespace.
* NetworkPolicies: Internal segmentation; EgressIP doesn’t replace them.
* Firewall Rules: Use the curated list of Egress IPs as explicit allowed sources.
* RHACS / SIEM Analytics: Detect destination drift or unusual data volume.

== Summary Table
| What to Secure | How | Benefit |
|----------------|-----|---------|
| Outbound Identity | Assign EgressIP | Rapid attribution |
| Firewall Scope | Limit to specific IPs | Reduced over-permit |
| Anomaly Detection | Baseline per IP | Faster anomaly triage |

== FAQs
Q: Does EgressIP replace NetworkPolicies?  
A: No—one handles identity outside the cluster, the other controls internal traffic.

Q: Can multiple namespaces share an EgressIP?  
A: Technically yes; operationally avoid—it muddies attribution.

Q: What if I need per‑pod identity?  
A: Consider service mesh or egress gateways; finer granularity raises management cost.

Q: Will this break existing connections?  
A: EgressIP applies to new flows; plan a maintenance window if deterministic attribution is critical midstream.

== Closing Story
EgressIP is the name tag at a crowded conference exit—suddenly you know exactly who just walked past the security desk.

== Next Step Ideas
* Pair with egress deny-all baseline + explicit allowlist
* Add monitoring alert on new destination ASN / geo
* Integrate with SIEM to tag egress events by namespace

